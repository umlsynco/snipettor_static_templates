<!-- Bootstrap Template Author: Filip Todorov www.filiptodorov.com -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="keywords" content="">
  <meta name="description" content="">
  <title>SW Architecture Snippets</title>
  <link rel="shortcut icon" href="img/favicon.ico" />
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="css/font-awesome.min.css" rel="stylesheet">
  <link href="css/bootstrap-tagsinput.css" rel="stylesheet">
  <link href="css/scrollbar.css" rel="stylesheet">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
                <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
              <![endif]-->
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="js/jquery-1.12.3.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap-tagsinput.min.js"></script>
  <script src="js/jquery.scrollbar.min.js"></script>
</head>

<body>

  <nav class="navbar navbar-inverse">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
        <a class="navbar-brand" href="index.html"><img src="img/002-code.png"> Snippetor</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Working Snippets <span class="caret"></span></a>
            <ul id="working_snippets_list" class="dropdown-menu">
              <!-- li class="dropdown-submenu">
                <a href="#"><i class="fa fa-fw fa-plus-circle"></i> Create new Snippet</a>
                <ul class="dropdown-menu">
                  <li><a href="#"><i class="fa fa-fw fa-github"></i> Github Snippet</a></li>
                  <li><a href="#"><i class="fa fa-fw fa-bitbucket"></i> Bitbucket Snippet</a></li>
                  <li><a href="#"><i class="fa fa-fw fa-google"></i> Chromium Snippet</a></li>
                </ul>
              </li -->
            </ul>
          </li>
          <li class="search">
            <input type="text" class="form-control" placeholder="Search Snippetor..">
            <div class="buttons">
              <button type="submit"><i class="fa fa-fw fa-search"></i></button>
              <button type="button" id="advancedSearchToggle"><i class="fa fa-fw fa-navicon"></i></button>
            </div>
            <div class="advanced">
              <a href="#" id="hideAdvanced"><i class="fa fa-fw fa-times"></i></a>
              <form action="search.php" method="post">
                <div class="form-group">
                  <label>Filter Output</label>
                  <select class="form-control">
                                            <option>All Snippets</option>
                                            <option>Draft Snippets</option>
                                            <option>Opened Snippets</option>
                                            <option>Modified Snippets</option>
                                        </select>
                </div>
                <div class="form-group">
                  <label>Looking by word</label>
                  <input type="text" class="form-control">
                </div>
                <div class="form-group">
                  <label>Author</label>
                  <div class="clearfix"></div>
                  <select class="form-control first-half">
                                            <option>Github</option>
                                            <option>Bitbucket</option>
                                            <option>Chromium</option>
                                        </select>
                  <input type="text" class="form-control second-half" placeholder="Author Name">
                  <div class="clearfix"></div>
                </div>
                <div class="form-group">
                  <label>Branch name</label>
                  <input type="text" class="form-control" data-role="tagsinput">
                </div>
                <div class="form-group">
                  <label>Hash Tags</label>
                  <input type="text" class="form-control" data-role="tagsinput">
                </div>
                <div class="checkbox">
                  <label>
                                            <input type="checkbox" id="uml"> Has UML?
                                        </label>
                </div>
                <div class="form-group" id="hasuml" style="display:none;">
                  <select class="form-control inline">
                                            <option>All</option>
                                            <option>Modified</option>
                                            <option>Created</option>
                                        </select>
                  <select class="form-control inline">
                                            <option>1 day</option>
                                            <option>2 days</option>
                                            <option>3 days</option>
                                            <option>4 days</option>
                                            <option>5+ days</option>
                                        </select>
                  <span class="inline-span">ago and has </span>
                  <select class="form-control inline">
                                            <option>more</option>
                                            <option>less</option>
                                        </select>
                  <span class="inline-span">than 3 comments</span>
                </div>
                <input type="submit" class="btn btn-primary" value="Search">
              </form>
            </div>
          </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#about">Settings</a></li>
          <li class="dropdown" id="signin-dropdown-menu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Sign In</a>
            <ul class="dropdown-menu">
              <li id="firebase-auth-google"><a href="#"><i class="fa fa-fw fa-google"></i> Google</a></li>
              <li id="firebase-auth-github"><a href="#"><i class="fa fa-fw fa-github"></i> Github</a></li>
              <!-- li><a href="#"><i class="fa fa-fw fa-bitbucket"></i> Bitbucket</a></li -->
            </ul>
          </li>
          <li class="dropdown" id="signout-dropdown-menu">
            <a id="signout-dropdown-menu-item" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
								<img src="img/avatar.jpg" class="mini-avatar">
							</a>
            <ul class="dropdown-menu">
              <img id="signout-dropdown-menu-avatar" src="img/avatar.jpg" class="big-avatar">
              <li><a href="/?dashboard"><i class="fa fa-fw fa-dashboard"></i> Dashboard</a></li>
              <li id="signout-firebase"><a href="#"><i class="fa fa-fw fa-sign-out"></i> Sign Out</a></li>
            </ul>
          </li>
        </ul>
      </div>
      <!--/.nav-collapse -->
    </div>
  </nav>

  <div class="tabs-header">
    <div class="container">
      <ul id="main-tabs-controll">
        <li id="tab-all-snippets"><a href="/"><img src="img/003-speedometer.png"> <span>All Snippets</span></a></li>
        <li id="tab-dashboard"><a href="/?dashboard"><img src="img/002-internet.png"> <span>Dashboard</span></a></li>
        <li id="tab-feed"><a href="/?feed"><img src="img/001-interface.png"> <span>User Feed</span></a></li>
      </ul>
    </div>
  </div>

  <div class="container">
    <div class="row" style="position:relative;">
      <div id="main-dashboard" class="col-sm-8">

        <div class="animationload">
          <div class="osahanloading"></div>
        </div>
        <nav aria-label="Page navigation">
          <ul class="pagination">
            <li>
              <a href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
            </li>
            <li><a href="#">1</a></li>
            <li><a href="#">2</a></li>
            <li><a href="#">3</a></li>
            <li><a href="#">4</a></li>
            <li><a href="#">5</a></li>
            <li>
              <a href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
            </li>
          </ul>
        </nav>

      </div>
      <div class="col-sm-4">
        <div class="sidebar-profile" id="snippetor-sidebar-profile">
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/3.6.7/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCLHGFmt-KvEV7pHmaYC2xQHz2Ary-f8X0",
      authDomain: "snipettor.firebaseapp.com",
      databaseURL: "https://snipettor.firebaseio.com",
      storageBucket: "snipettor.appspot.com",
      messagingSenderId: "1024573617684"
    };
    firebase.initializeApp(config);
  </script>

  <script>
    $("#advancedSearchToggle").click(function(e) {
      e.preventDefault();
      $(this).parent().siblings(".advanced").slideToggle(150);
    });
    $("#hideAdvanced").click(function(e) {
      e.preventDefault();
      $(this).parent().slideToggle(150);
    });
    $(".labels-list .list i").click(function(e) {
      e.preventDefault();
      $(this).siblings(".details").fadeToggle(150);
    })
    $(".color").click(function(e) {
      e.preventDefault();
      $(this).parent().siblings("ul").children("li").css("color", $(this).data("color"));
    })
    $(".panel-labels li").click(function(e) {
      e.preventDefault();
      $(this).children(".colors").fadeToggle().toggleClass("active");
    })
    $(".colors").click(function(e) {
      e.preventDefault();
      return false;
    })
    $(".colors span").click(function(e) {
      e.preventDefault();
      $(this).parent().parent().css("color", $(this).data("color"));
    })
    $(document).click(function(e) {
      var target = $(e.target),
        article;
      if (!target.is(".colors") && !target.parent().is(".panel-labels")) {
        if ($(".colors").hasClass("active")) {
          $(".colors").removeClass("active").fadeOut();
        }
      }
    });
    /* ADD TO ALL NEW PAGES */
    $('.sidebar-profile').scrollbar({
      disableBodyScroll: true,
      autoUpdate: true,
      showArrows: true
    });
    $("#uml").change(function(e) {
      if ($(this).is(":checked")) {
        $("#hasuml").fadeIn();
      } else {
        $("#hasuml").fadeOut();
      }
    })
  </script>
  <script>
    /* Nano Templates - https://github.com/trix/nano */

    function nano(template, data) {
      return template.replace(/\{([\w\.]*)\}/g, function(str, key) {
        var keys = key.split("."),
          v = data[keys.shift()];
        for (var i = 0, l = keys.length; i < l; i++) v = v[keys[i]];
        return (typeof v !== "undefined" && v !== null) ? v : "";
      });
    }
  </script>
  <script>
    function getTemplateGlobal(name, data) {
      var template = "";
      if (name == "comment_old_1") {
        template =
          '\
<div class="panel panel-default">\
    <i class="fa fa-chevron-down fa-3x" style="float: left;position: relative;left: -50px;top: 70px;"></i>\
    <i class="fa fa-chevron-up fa-3x" style="float: left;left: -93px;position: relative;top: 20px;"></i>\
<div class="panel-heading">\
  <div class="title">\
    <a href="{item.prefix}"><p><i class="fa fa-{item.img}"></i></p></a><!--\
    --><a href="#">{item.user}</a> <span class="divider"></span><!--\
    --><a href="#">{item.repo}</a> <span class="divider"></span><!--\
    --><a href="#">{item.path}</a> <span class="divider"></span><!--\
    --><a href="#">:{item.line}</a>\
  </div>\
  <div class="stats">\
    <!--\
    --><div><img class="close-snippet-item-icon" src="img/close.png"></div>\
  </div>\
  <div class="clearfix"></div>\
</div>\
<div class="panel-body">\
  <p style="position:relative; float:right;"><i class="fa fa-edit"></i></p>\
  <span class="snippet-description">{item.comment}</span></div>\
</div>';

      } else if (name == "comment_old_2") {
        template =
          '\
<div class="panel panel-default">\
    <i class="fa fa-chevron-down fa-3x" style="float: left;position: relative;left: -50px;top: 70px;"></i>\
    <i class="fa fa-chevron-up fa-3x" style="float: left;left: -93px;position: relative;top: 20px;"></i>\
    <div class="panel-heading">\
      <div class="title">\
        <a href="{item.prefix}"><p><i class="fa fa-{item.img}"></i></p></a><!--\
        --><a href="#">{item.path}</a><!--\
        --><a href="#"> : {item.line}</a>\
      </div>\
                            <div class="stats">\
                                <!--\
                             --><div><img class="close-snippet-item-icon" src="img/close.png"></div>\
                            </div>\
      <div class="clearfix"></div>\
    </div>\
    <div class="panel-body">\
		<p style="position:relative; float:right;">\
			<i class="fa fa-edit"></i>\
		</p>\
		<span class="snippet-description">{item.comment}</span></div>\
   </div>\
</div>';
      } else if (name == "snippet") {
        template =
          '\
                    <div class="panel panel-default">\
                        <div class="panel-heading">\
                            <div class="title">{snippet.title}</div>\
                            <div class="stats">\
                                <div><img src="img/comment.png">{snippet.n_comments}</div><!--\
                             --><div><img src="img/previews.png">{snippet.n_watches}</div><!--\
                             --><div><img src="img/likes.png">{snippet.n_likes}</div>\
                            </div>\
                            <div class="clearfix"></div>\
                        </div>\
                        <div class="panel-body">\
                            <div class="row">\
                                <div class="col-sm-4 vcenter">\
                                    <div class="profile">\
                                        <img src="https://avatars0.githubusercontent.com/u/6011629?v=3&s=460" class="avatar">\
                                        <h2 class="name"><a href="/?user_id={snippet.user_id}">{snippet.username}</a></h2>\
                                    </div>\
                                    <a uid="{snippet.uid}" xuid="{snippet.xuid}" class="btn btn-primary snippetor-play-snippet-new">Play <i class="fa fa-fw fa-play"></i></a>\
                                    <a href="/?open={snippet.uid}" class="btn btn-default">Details <i class="fa fa-fw fa-edit"></i></a>\
                                </div><!--\
                             --><div class="col-sm-8 border-left vcenter">\
                                    <div class="{snippet.has_description}description">\
                                        {snippet.description}\
                                        <!-- Hash Tags -->\
                                        <ul class="hashtags">\
                                        {snippet.tags}\
                                        </ul>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="panel-footer">\
                            <ul class="repositories">\
                            {snippet.branches}\
                            </ul>\
                        </div>\
                    </div>';
      } else if (name == "save-view") {
        template =
          '<div class="panel panel-default">\
               <div class="panel-heading">\
                   <div class="title"><i class="fa fa-fw fa-eye" style="opacity:0.25;margin-right:5px;"></i> Snippet {snippet.uid}</div>\
                   <div class="stats" style="display:block;"><div id="delete-snippet"><img src="img/garbage.png"></div></div>\
                   <div class="clearfix"></div>\
               </div>\
               <div class="panel-body">\
                   <div class="row">\
                       <div class="col-sm-7">\
                           <a name="play" class="btn btn-primary btn-margin-right-5">Play <i class="fa fa-fw fa-play"></i></a>\
                           <a name="save" class="btn btn-default btn-margin-right-5" style="display:none;">Save <i class="fa fa-fw fa-save"></i></a>\
                           <a name="edit" class="btn btn-default btn-margin-right-5" style="display:none;">Edit <i class="fa fa-fw fa-edit"></i></a>\
                           <a name="fork" class="btn btn-default btn-margin-right-5" style="display:none;">Fork <i class="fa fa-fw fa-code-fork"></i></a>\
                           <a name="revert" class="btn btn-default btn-margin-right-5" style="display:none;">Rever <i class="fa fa-fw fa-undo"></i></a>\
                           <a name="delete" class="btn btn-default btn-margin-right-5">Delete <i class="fa fa-fw fa-trash"></i></a>\
                           <a name="cancel" class="btn btn-default btn-margin-right-5">Cancel <i class="fa fa-fw fa-close"></i></a>\
                           <a name="close" class="btn btn-default btn-margin-right-5">Close <i class="fa fa-fw fa-close"></i></a>\
                       </div>\
                       <div class="col-sm-5 text-right">\
                           <a name="like" href="#" class="btn btn-warning btn-margin-right-5 active">Like Snippet <i class="fa fa-fw fa-heart"></i></a>\
                           <a name="watch" class="btn btn-warning btn-margin-right-5">Watch <i class="fa fa-fw fa-eye"></i></a>\
                       </div>\
                       <div class="col-sm-12" id="snipettor-save-form">\
                           <div class="alert alert-danger snippetor-alert"><i class="fa fa-fw fa-warning"></i> Users who are not logged in, cannot save their snappet.</div>\
                           <form action="" method="post" class="edit-form">\
                               <div class="form-group">\
                                   <label>Title</label>\
                                   <input id="snippetor-save-title" type="text" class="form-control {snippet.editable}" value="{snippet.title}" {snippet.disabled}>\
                               </div>\
                               <div class="form-group">\
                                   <label>Tags</label>\
                                   <input id="snippetor-save-tags" type="text" class="form-control  {snippet.editable}" data-role="tagsinput" value="{snippet.tags}" {snippet.disabled}>\
                               </div>\
                               <div class="form-group">\
                                   <label>Description</label>\
                                   <textarea id="snippetor-save-description" class="form-control {snippet.editable}" rows="5" {snippet.disabled}>{snippet.desc}</textarea>\
                               </div>\
                           </form>\
                           <hr>\
                       </div>\
                   </div>\
               </div>\
           </div>';
      } else if (name == "save-view-item") {
        template =
          '<div class="panel panel-default">\
            <div class="panel-heading">\
                <div class="title">\
                    <i class="fa fa-fw fa-{item.source}" style="opacity:0.25;margin-right:5px;"  onClick="window.open(\'{item.prefix}\');"></i>\
                    <span data-toggle="tooltip" data-placement="top" title="Username" onClick="window.open(\'{item.prefix}/{item.username}\');">{item.username}</span><!--\
                 --><span data-toggle="tooltip" data-placement="top" title="Repository" onClick="window.open(\'{item.prefix}/{item.username}/{item.repo}\');">{item.repo}</span><!--\
                 --><span data-toggle="tooltip" data-placement="top" title="Path" onClick="window.open(\'{item.prefix}/{item.username}/{item.repo}/{item.path}\');">{item.path}</span><!--\
                 --><span data-toggle="tooltip" data-placement="top" title="Line Number" onClick="window.open(\'{item.prefix}/{item.username}/{item.repo}/{item.path}{item.lineprefix}{item.line}\');">{item.line}</span>\
                </div>\
                <div class="stats" style="display:{item.save_vis};"><div><img src="img/garbage.png"></div></div>\
                <div class="clearfix"></div>\
            </div>\
            <div class="panel-body bordered">\
                <div class="pull-right" style="display:{item.save_vis};"><a href="#" class="editComment"><i class="fa fa-fw fa-edit"></i> Edit Comment</a></div>\
                <div class="clearfix"></div>\
                <p style="display:{item.view_vis};">{item.comment}</p>\
                <textarea class="form-control" rows="4" disabled="" style="display:{item.save_vis};">{item.comment}</textarea>\            </div>\
        </div>';
      } else if (name == "save-view-item-google") {
        template =
          '<div class="panel panel-default">\
           <div class="panel-heading">\
               <div class="title">\
                   <i class="fa fa-fw fa-{item.source}" style="opacity:0.25;margin-right:5px;" onClick="window.open(\'{item.prefix}\');"></i>\
                <span data-toggle="tooltip" data-placement="top" title="Path" onClick="window.open(\'{item.prefix}/{item.path}\');">{item.path}</span><!--\
                --><span data-toggle="tooltip" data-placement="top" title="Line Number" onClick="window.open(\'{item.prefix}/{item.path}{item.lineprefix}{item.line}\');">{item.line}</span>\
               </div>\
               <div class="stats" style="display:{item.save_vis};"><div><img src="img/garbage.png"></div></div>\
               <div class="clearfix"></div>\
           </div>\
           <div class="panel-body bordered">\
               <div class="pull-right" style="display:{item.save_vis};"><a href="#" class="editComment"><i class="fa fa-fw fa-edit"></i> Edit Comment</a></div>\
               <div class="clearfix"></div>\
               <p style="display:{item.view_vis};">{item.comment}</p>\
               <textarea class="form-control" rows="4" disabled="" style="display:{item.save_vis};">{item.comment}</textarea>\           </div>\
       </div>';
      } else if (name == "save-view-item-uml") {
        template =
          '<div class="panel panel-default">\
            <div class="panel-heading">\
                <div class="title">\
                    <i class="fa fa-fw fa-{item.source}" style="opacity:0.25;margin-right:5px;" onClick="window.open(\'{item.prefix}\');"></i>\
                 <span data-toggle="tooltip" data-placement="top" title="Path" onClick="window.open(\'{item.prefix}/{item.path}\');">{item.path}</span><!--\
                 --><span data-toggle="tooltip" data-placement="top" title="UML element">{item.element}</span>\
                </div>\
                <div class="stats" style="display:{item.save_vis};"><div><img src="img/garbage.png"></div></div>\
                <div class="clearfix"></div>\
            </div>\
            <div class="panel-body bordered">\
            <div class="pull-right" style="display:{item.save_vis};"><a href="#" class="editComment"><i class="fa fa-fw fa-edit"></i> Edit Comment</a></div>\
                <div class="clearfix"></div>\
                <p style="display:{item.view_vis};">{item.comment}</p>\
                <textarea class="form-control" rows="4" disabled="" style="display:{item.save_vis};">{item.comment}</textarea>\
            </div>\
        </div>';
      } else if (name == "user-profile-details") {
        template =
          '<div class="box-shadow-area">\
          <div class="avatar-area" style="background: url(\'{profile.avatar}\') center no-repeat">\
            <div class="avatar-bg"></div>\
          </div>\
          <div class="profile-details">\
            <img src="{profile.avatar}" class="avatar-image">\
            <h1><i class="fa fa-fw fa-github"></i>{profile.username}</h1>\
          </div>\
          <div class="followers">\
            <div class="part">\
              <h2>{profile.followers}</h2>\
              <h3>followers</h3>\
            </div>\
            <!--\
                           -->\
            <div class="part">\
              <h2>{profile.following}</h2>\
              <h3>following</h3>\
            </div>\
            <!--\
                           -->\
            <div class="part">\
              <a href="#" class="btn btn-primary"><i class="fa fa-fw fa-user-o"></i> Follow</a>\
            </div>\
          </div>\
        </div>';
      }

      return nano(template, data);
    }
  </script>
  <script>
    //
    // storage abstract API (Firebase implementation)
    //
    var storageApi = {
      observers: [],
      addObserver: function(observer) {
        this.observers.push(observer);
      },
      init: function() {
        // make firebase initialization here
        this.auth = firebase.auth();
        this.database = firebase.database();
        this.storage = firebase.storage();
        // Initiates Firebase auth and listen to auth state changes.
        this.auth.onAuthStateChanged(this._onAuthStateChanged.bind(this));
      },
      authCallback: function(user) {
        if (!user) return;
        var ref = this.database.ref('user_details');
        var userData = {
          photo: user.photoURL,
          name: user.displayName,
          following: 0,
          followers: 0,
          seflFF: false // indicates is user follow itself (reduce the number of requests to firebase)
        };
        ref.child(user.uid).transaction(function(currentUserData) {
          console.dir("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
          console.dir(currentUserData);
          if (currentUserData === null)
            return userData;
        }, function(error, committed) {
          console.dir(committed);
          // TBD handle if necessary;
        });
      },
      //
      // Helper method to handle sign-in change behaviour
      //
      _onAuthStateChanged: function(user) {
        this.user = user;
        if (this.authCallback) {
          // probably it could trigger firebase:auth event
          this.authCallback(user);
        }
        //
        // Notify all registered observers
        //
        for (var x = 0; x < this.observers.length; ++x) {
          if (this.observers[x] && this.observers[x].onAuthChanged)
            this.observers[x].onAuthChanged(user);
        }
      },
      //
      // Helper method to hide storage selection
      // for the authenticated and anonimous users
      //
      _getMessageRef: function(type) {
        if (type == 'content') {
          if (!this.umlsRef) {
            this.umlsRef = this.database.ref('messages');
          }
          return this.umlsRef;
        }
      },
      //
      // Save a new content
      //
      saveContent: function(payload, callback) {

        var messagesRef = this._getMessageRef('content');
        if (!messagesRef)
          callback(null);

        var currentUser = this.auth.currentUser;

        messagesRef.push({
          version: 0, // default is 0
          // no idea how to reformat it now, but may be later
          user_name: currentUser ? currentUser.displayName : "unknown",
          user_id: currentUser ? currentUser.uid : "unknown",
          // Snippet title an description
          title: payload.title, // UML title
          description: payload.description || "", // uml/class etc or markdown
          // arrays
          tags: payload.tags || [], // uml/class etc or markdown
          branches: payload.branches || [], // uml/class etc or markdown
          items: payload.items, // JSON description
        }).then(function(snapshot) {
          if (callback) {
            callback(snapshot.path);
          }
        }.bind(this)).catch(function(error) {
          var text = 'Error writing new message to Firebase Database';
          console.error(text, error);
          callback(null, text);
        });

      },
      //
      // Load content by key and version
      //
      loadContent: function(uid2, version, callback) {
        var uid = "-" + uid2;
        var that = this;
        var handler = function(snapshot) {
          if (callback)
            callback(snapshot.val());
          var xxx = snapshot.val();
          console.dir(xxx);
        };
        var handler2 = function(snapshot) {
          if (callback) {
            var xxx = snapshot.val();
            for (var x in xxx) {
              callback(xxx[x]);
            }
          }
        };

        if (false && version) {
          var ref = this.database.ref('messages/' + uid + "/" + version);
          ref.limitToFirst(1).once("value").then(handler2);
        } else {
          this.messagesRef = this.database.ref('messages/' + uid).once('value').then(handler);
        }
      },
      //
      // Update the content and version
      //
      updateContent: function(uid, payload, callback) {
        var messagesRef = this._getMessageRef('content');
        if (!messagesRef)
          callback(null, "Error: invalid firebase path.");
        var ref = messagesRef.child("-" + uid);
        if (!ref)
          callback(null, "Error: invalid content id: -" + uid + " .");

        var currentUser = this.auth.currentUser;

        ref.set({
          version: 0, // default is 0
          // no idea how to reformat it now, but may be later
          user_name: currentUser ? currentUser.displayName : "unknown",
          user_id: currentUser ? currentUser.uid : "unknown",
          // Snippet title an description
          title: payload.title, // UML title
          description: payload.description || "", // uml/class etc or markdown
          // arrays
          tags: payload.tags || [], // uml/class etc or markdown
          branches: payload.branches || [], // uml/class etc or markdown
          items: payload.items, // JSON description
        }).then(function(snapshot) {
          if (callback) {
            callback(snapshot.path);
          }
        }.bind(this)).catch(function(error) {
          var text = 'Error writing new message to Firebase Database';
          console.error(text, error);
          callback(null, text);
        });
      },
      updateContentWithVersion: function(uid, payload, callback) {
        var msg = this._getMessageRef('content');
        if (msg) {
          var ref = msg.child("-" + uid);
          ref.child('version').once('value').then(function(x) {
            var position = x.val() + 1;
            ref
              .child(position)
              .push({
                data: payload.data,
                title: payload.title,
                type: payload.type
              })
              .then(function(snapshot) {
                if (callback) {
                  callback(snapshot.path);
                }
                ref.update({
                  version: position
                });
              }.bind(this))
              .catch(function(error) {
                var text = 'Error updating existing content to Firebase Database';
                console.error(text, error);
                callback(null, text);
              });
          }); // ref get value
        }
      },
      //
      // request users's like and watch snippet
      // details
      // params:
      // @request = userUID + snippetUID
      //
      requestLikeAndWatch: function(uid, callback) {
        this.database.ref('likes/' + uid)
          .once('value')
          .then(function(complete) {
            callback(complete.val());
          });
      },
      //
      // Update current status of like and watch for the
      // concreate user
      //
      setLikeAndWatch: function(uid, data) {
        var ref = this.database.ref('likes')
        ref.child(uid).transaction(function(currentData) {
          console.dir("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
          console.dir(currentData);
          return data;
        }, function(error, committed) {
          console.dir(committed);
        });
      },

      //
      // Show the latest content only
      //
      searchContent: function(queryText, callback, user_id) {
        // Search content for current user
        if (user_id) {
          this.database.ref('messages')
            .limitToLast(20)
            .orderByChild('user_id')
            .equalTo(user_id)
            .once('value')
            .then(function(complete) {
              callback(complete.val());
            });

          return;
        }
        if (false && queryText) {
          this.database.ref('messages')
            .limitToLast(20)
            .orderByChild('title')
            .startAt(queryText)
            .endAt(queryText + "\uf8ff")
            .once('value')
            .then(function(complete) {
              callback(complete.val());
            });
        } else {
          this.database.ref('messages')
            .limitToLast(20)
            .once('value')
            .then(function(complete) {
              callback(complete.val());
            });
        }
      },
      getUserInfo: function(uid, callback) {
        var ref = this.database.ref('user_details/' + uid);
        ref.once("value").then(function(x1, x2, x3) {
          callback(x1.val());
        });
      }
    }; // StorageApi

    //
    // Communication with an extension web-site injection plugin
    //
    var snippetorExtensionService = {
      observers: [],
      addObserver: function(observer) {
        this.observers.push(observer);
      },
      openSnippet: function(payload, idx) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "open-snippet",
            data: {
              payload: payload,
              index: idx
            }
          }
        }));
      },
      onSavedSnippet: function(payload) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "saved-draft",
            payload: payload
          }
        }));

      },
      onEditCurrentSnippet: function(payload) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "edit-current-snippet",
            payload: payload
          }
        }));
      },
      subscribers: [],
      subscribeSnippet: function(uid, observer) {
        this.subscribers[uid] = observer;
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "subscribe",
            payload: {
              payload: {
                uid: uid
              }
            }
          }
        }));
        // setup working snippet if it was opend via regual web API for view
        for (var x in this.snippets)
          if (this.snippets[x] && this.snippets[x].uid == uid)
            this.working_snippet = x;
      },
      onUnsubscribeSnippet: function(payload) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "unsubscribe",
            payload: payload
          }
        }));
      },
      //
      // HAndle snippet items
      //
      onAddItem: function(payload) {
        if (!this.initialized)
          return;
        // Update current cache (TBD: fo future when it will be not necessary to reload all page)
        this.snippets[payload.working].items.splice(payload.index, 0, payload.item);

        //
        // Notify only if we are subscribed on it
        if (payload.working == this.working_snippet) {
          // Handle UI part
          this.notifyObservers("onAddItem", payload);
        }
      },
      onRemoveItem: function(payload) {
        if (!this.initialized)
          return;
        this.snippets[payload.working].items.splice(payload.index, 1);

        // Handle UI part
        if (payload.working == this.working) {
          this.notifyObservers("onRemoveItem", payload);
        }
      },
      onUpdateItem: function(payload) {
        if (!this.initialized)
          return;

       this.snippets[payload.working].items[payload.payload.idx].comment = payload.payload.item.comment;
        // Handle UI part
        if (payload.working == this.working) {
          this.notifyObservers("onUpdateItem", payload.payload);
        }
      },
      onMoveItem: function(payload) {
        if (!this.initialized)
          return;

        var item = this.snippets[payload.working].items[payload.payload.oldIndex];
        this.snippets[payload.working].items.splice(payload.payload.oldIndex, 1);
        this.snippets[payload.working].items.splice(payload.payload.newIndex, 0, item);

        // Handle UI part
        if (payload.working == this.working) {
          this.notifyObservers("onMoveItem", payload.payload);
        }
      },
      //
      // Notify all observers whic has "method"
      //
      notifyObservers: function(method, payload) {
        for (var x = 0; x < this.observers.length; ++x) {
          if (this.observers[x] && this.observers[x][method]) {
            this.observers[x] && this.observers[x][method](payload);
          }
        }
      },
      snippets: [],
      working_snippet: -1,
      initialized: false,
      isInitialized: function() {
        return this.initialized;
      },
      //
      // Indicates is extension was installed
      //
      hasExtension: function() {
        return true;
      },
      //
      // Get current working snippet
      //
      getWorkingSnippet: function() {
        if (this.initialized && this.working_snippet >= 0 && this.snippets.length > 0) {
          return this.snippets[this.working_snippet];
        }
        return null;
      },
      //
      // Get opened snippet by UID
      //
      getSnippetByUid: function(uid) {
        if (!this.initialized)
          return;
        for (var r in this.snippets) {
          if (this.snippets[r] && this.snippets[r].uid == uid)
            return this.snippets[r];
        }
        return null;
      },
      //
      // subscribed for callbacks
      //
      init: function() {
        var that = this;
        window.addEventListener("onInit", function(evt) {
          that.initialized = true;
          that.snippets = evt.detail.snippets;
          that.working_snippet = evt.detail.working;
          snippetorExtensionService.notifyObservers("initCallback", evt.detail);
        });
        window.addEventListener("onSnippetChange", function(evt) {
          var payload = evt.detail;
          if (payload.action == "save") {
            // SAVED SNIPPET NOT LONGER AVAILABLE
            that.snippets[payload.working] = null;
            snippetorExtensionService.notifyObservers("onSaveSnippet", payload);
          } else if (payload.action == "create") {
            // CREATE DRAFT FROM SCRATCH
            that.snippets[payload.working] = payload.snippets;
            snippetorExtensionService.notifyObservers("onCreateSnippet", payload);
          } else if (payload.action == "open") {
            // OPEN SNIPPET FROM THE WEB
            that.snippets[payload.working] = payload.snippets;
          snippetorExtensionService.notifyObservers("onOpenSnippet", payload);
          } else if (payload.action == "edit-state") {
            console.log("TODO: ADD edit state handling");
          } else {
            alert("Unknow snippet action: " + payload.action);
          }
        });

        window.addEventListener("onSnippetItemChange", function(evt) {
          var payload = evt.detail;
          if (payload.action == "add") {
            that.onAddItem(payload);
          } else if (payload.action == "remove") {
            that.onRemoveItem(payload);
          } else if (payload.action == "update") {
            that.onUpdateItem(payload);
          } else if (payload.action == "move") {
            that.onMoveItem(payload);
          } else {
            alert("Unknow snippet action: " + payload.action);
          }
        });


        setTimeout(function() {
          console.log("GET INITIAL STATE!!!!");
          window.dispatchEvent(new CustomEvent("onSnipettorAction", {
            detail: {
              action: "GetInitialState"
            }
          }));
        }, 100);
      },
      //
      // Assign current tab to the concreate snippet or snippet draft
      // @param payload - index of the selected item, (-1) is to unsubscribe
      //
      selectSnippetByIndex: function(index) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "select-snippet",
            data: index
          }
        }));
      },
      //
      // Update current snippet data:
      // title, hash-tags or description
      //
      updateSnippet: function(payload) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: "update-snippet",
            payload: payload
          }
        }));
      },
      //
      // Update the concreate snippet item's description
      // 1. update - update description
      // 2. delete - item removed
      // 3. position - change item position
      //
      updateSnippetItem: function(action, payload) {
        window.dispatchEvent(new CustomEvent("onSnipettorAction", {
          detail: {
            action: action + "-snippet-item",
            payload: payload
          }
        }));
      }
    };

    //
    // Routing service handler
    //
    var routingServiceApi = {
      observers: [],
      addObserver: function(observer) {
        this.observers.push(observer);
        if (this.initialized) {
          observer(this.state, null, this.payload);
        }
      },
      notifyObservers: function(method, d1, d2, d3) {
        for (var x = 0; x < this.observers.length; ++x) {
          if (this.observers[x] && this.observers[x][method]) {
            this.observers[x] && this.observers[x][method](d1, d2, d3);
          }
        }
      },
      changeUrl: function(uri, silence) {
        if (!silence) {
          window.location.href = uri;
          return;
        }
        window.history.pushState(null, "Snippetor", uri);
        this.init(uri);
      },
      // cache current routing state
      //
      state: null,
      // initalize routing data
      //
      init: function(xurl) {
        var content = xurl.split("?");
        var isSearch = true;

        var newState = null;
        var payload = null;
        //
        // Root URL
        //
        if (content.length == 1) {
          newState = "all-snippets";
        }
        //
        // Query URL
        //
        else {
          content = content[1];
          if (content.indexOf("save") >= 0) {
            // save snippet DRAFT
            newState = "save-snippet";
            var content = content.substr(5);
            if (content.toUpperCase() != "DRAFT") {
              var uid = content.substr(0, content.length).split("/");
              var version = uid[1] || 0;
              uid = uid[0];
              payload = {
                uid: uid,
                version: version
              };
            }
          } // save
          else if (content.indexOf("open") >= 0) {
            var content = content.substr(5);
            var uid = content.substr(0, content.length).split("/");
            var version = uid[1] || 0;
            uid = uid[0];
            payload = {
              uid: uid,
              version: version
            };
            // view stored snippet
            newState = "view-snippet";
          } else if (content.indexOf("search") >= 0) {
            //              $("#tab-all-snippets").addClass("active");
            var searchString = decodeURI(content).split("&");
            var searcher = {};
            for (var x = 0; x < searchString.length; ++x) {
              var m = searchString[x].split("=");
              if (searchString.length - 1 == x) {
                searcher[m[0]] = m[1].substr(0, m[1].length - 1);
              } else {
                searcher[m[0]] = m[1];
              }
            }
            if (searcher["search"] == "*")
              searcher["search"] = null;
            newState = "search-snippet";
            payload = searcher;
          } else if (content.indexOf("dashboard") >= 0) {
            /*              $("#tab-dashboard").addClass("active");
                          // Show current user dashboard
                          $('[aria-controls="main-dashboard"]').trigger("click");
                          global_action = "dashboard";
                          global_method = function(user_id) {
                            storageApi.searchContent({
                                search: null
                              }, function(content) {
                                showSearchResult({
                                  search: null
                                }, content, "#main-dashboard");
                              },
                              user_id);
                          }; // global_method
            */
            newState = "dashboard";
          } else if (content.indexOf("feed") >= 0) {
            /*
                          $("#tab-feed").addClass("active");
                          // Show current user dashboard
                          $('[aria-controls="main-dashboard"]').trigger("click");
                          global_action = "dashboard";
                          global_method = function(user_id) {
                            storageApi.searchContent({
                                search: null
                              }, function(content) {
                                showSearchResult({
                                  search: null
                                }, content, "#main-dashboard");
                              },
                              user_id);
                          }; // global_method
            */
            newState = "feed";

          } else if (content.indexOf("user_id") >= 0) {
            newState = "dashboard";

            //              $("#tab-dashboard").addClass("active");
            var sst = decodeURI(content).split("&");
            var first = sst[0].split("=");
            var user_id = first[1];

            // user id to show for
            payload = {
              uid: user_id
            };
            // Show current user dashboard
            /*              $('[aria-controls="main-dashboard"]').trigger("click");
                          storageApi.searchContent({
                              search: null
                            }, function(content) {
                              showSearchResult({
                                search: null
                              }, content, "#main-dashboard");
                            },
                            user_id);*/
          }; // in that case we know user id and could start search imidiatly
        }

        //
        // notify all observers about state change
        this.notifyObservers("onRoutingChanged", this.state, newState, payload);
        this.state = newState;
        this.payload = payload;
        this.initialized = true;

        //
        // Search UI contains tabs
        //
        /*          if (isSearch) {
                    $('[aria-controls="main-content"]').click(function() {
                      window.location.href = "/";
                    });

                    $('[aria-controls="main-dashboard"]').click(function() {
                      window.location.href = "/?dashboard";
                    });
                  }*/
        //}
      }
    };


    var tabsController = {
      init: function(loginService, routingService) {
        routingService.addObserver(this);
        loginService.addObserver(this);
      },
      onRoutingChanged: function(oldR, newR, payload) {
        this.routingState = newR;
        this._updateComponent();
      },
      authInitialized: false,
      onAuthChanged: function(newUser) {
        this.authInitialized = true;
        this.uid = newUser ? newUser.uid : null;
        this._updateComponent();
      },
      _updateComponent: function() {
        $("#main-tabs-controll>li").removeClass("active");
        if (this.routingState == "all-snippets" || this.routingState == "search") {
          $("#main-tabs-controll>li#tab-all-snippets").addClass("active");
          return;
        }
        if (this.routingState == "dashboard") {
          $("#main-tabs-controll>li#tab-dashboard").addClass("active");
          return;
        }
        if (this.routingState == "feed") {
          $("#main-tabs-controll>li#tab-feed").addClass("active");
          return;
        }
        $("#main-tabs-controll").parent().parent().hide();
      }
    };

    var workingSnippetsComponent = {
      init: function(extensionService) {
        extensionService.addObserver(this);
        this.extensionService = extensionService;
      },
      //
      // Update component on all actions
      initCallback: function(response) {
        this._updateComponent();
      },
      onSaveSnippet: function(payload) {
        this._updateComponent();
      },
      onCreateSnippet: function(payload) {
        this._updateComponent();
      },
      onOpenSnippet: function(payload) {
        this._updateComponent();
      },
      _updateComponent: function() {
        $("#working_snippets_list>li.working_snippet_item").remove();
        if (!this.extensionService.isInitialized())
          return;

        for (var x in this.extensionService.snippets) {
          var item = this.extensionService.snippets[x];
          //          <li><a href="#"><i class="fa fa-fw fa-floppy-o"></i> Draft Snippets</a></li>
          //          <li><a href="#"><i class="fa fa-fw fa-files-o"></i> Opened Snippets</a></li>
          if (item)
            $('<li class="working_snippet_item" idx="' + x +'">\
               <a href="#"><i class="fa fa-fw fa-edit"></i>'
                + item.title.substr(0, 20) + '</a></li>')
            .prependTo("#working_snippets_list");

        }
        // handle select
        var that = this;
        $("li.working_snippet_item").click(function(e) {
          if (!that.extensionService.isInitialized()) {
            return;
          }
          if (!that.extensionService.hasExtension()) {
            alert("You need to install extension");
            return;
          }
          var idx = $(this).attr("idx");
          idx = parseInt(idx);
          // Select/open concreate snippet
          that.extensionService.selectSnippetByIndex(idx);
          // Reload page with data from extenion
          setTimeout(function() {
            window.location.href = "/?save=draft";
          }, 100);
        });
      }
    };

    //
    // Right top navigation menu items
    // @implements:  StorageApiObserver.onAuthStateChanged
    // @dependson:   firebase API
    //
    var singInMenuComponent = {
      init: function(firebase, storageApi) {
        //
        //
        //
        storageApi.addObserver(singInMenuComponent);
        //
        // Sign in with GOOGLE
        //
        $("#firebase-auth-google").click(function() {
          var provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().signInWithPopup(provider).then(function(result) {
            // This gives you a GitHub Access Token. You can use it to access the GitHub API.
            var token = result.credential.accessToken;
            // The signed-in user info.
            var user = result.user;
          }).catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // The email of the user's account used.
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
          });
        });
        //
        // Sign in with GITHUB
        //
        $("#firebase-auth-github").click(function() {
          var provider = new firebase.auth.GithubAuthProvider();
          firebase.auth().signInWithPopup(provider).then(function(result) {
            // This gives you a GitHub Access Token. You can use it to access the GitHub API.
            var token = result.credential.accessToken;
            // The signed-in user info.
            var user = result.user;
          }).catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // The email of the user's account used.
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
          });
        });
        //
        // Sign out
        //
        $("#signout-firebase").click(function() {
          firebase.auth().signOut().then(function() {
            window.location.href = "/";
          }, function(error) {
            window.location.href = "/";
          });
        });
      }, // END init
      //
      // Firebase observer method
      // Update an authentication options
      //
      onAuthChanged: function(currentUser) {
        //
        // Hide login menu and insert user avatar
        //
        if (currentUser) {
          console.dir(currentUser);
          //currentUser.photoURL  ddddd
          $("#signin-dropdown-menu").hide();
          $("#signout-dropdown-menu").show();

          //
          //
          var photo = (currentUser.photoURL ? currentUser.photoURL : "img/avatar.jpg");
          $("a#signout-dropdown-menu-item").html(currentUser.displayName + '<img src="' + photo + '" class="mini-avatar">');
          // Change the dropdown menu avatar
          $("#signout-dropdown-menu-avatar").attr("src", photo);
        }
        //
        // Handle sign out or not loginned user use-case
        //
        else {
          $("#signin-dropdown-menu").show();
          $("#signout-dropdown-menu").hide();
        }
      }
    };


    // component which is responsible for the list of snippets
    // showing and update.
    // @depends - depends on login and routing services
    // @required - uses firebase storage service
    //
    var searchListComponent = {
      init: function(routingService, loginService, storageService) {
        // cache the storage service
        this.storageService = storageService;
        // subscribe on login change and routing change
        routingService.addObserver(this);
        loginService.addObserver(this);
      },
      storageService: null,
      routingAction: null,
      userId: null,
      //
      // Routing service callback method
      //
      onRoutingChanged: function(oldRouting, routingAction, payload) {
        console.log("ROUTING CHANGED");
        this.routingAction = routingAction;
        this.payload = payload;
        this._updateComponent();
      },
      //
      // Authenticatoin service callback method
      //
      onAuthChanged: function(currentUser) {
        console.log("AUTH CHANGED !!!");
        console.dir(currentUser);
        this.userId = currentUser ? currentUser.uid : null;
        this._updateComponent();
      },
      //
      // Request snippets list again
      //
      _updateComponent: function() {
        console.log("SEARCH COMPONENT !!!" + this.routingAction);
        if (this.routingAction != "all-snippets" &&
          this.routingAction != "dashboard" &&
          this.routingAction != "feed" &&
          this.routingAction != "search")
          return;
        var search = null;
        // TODO: identify if user callback not got or wrong url
        if (!this.userId &&
          (this.routingAction == "dashboard" || this.routingAction == "feed")) {
          // alert("Wrong sequence or not loginned user");
          return;
        }

        if (this.routingAction == "all-snippets") {
          searcher = null;
        } else if (this.routingAction == "dashboard") {
          var uid = this.payload && this.payload.uid ? this.payload.uid : this.userId;
          searcher = {
            user_id: uid
          };
        } else if (this.routingAction == "search-snippets") {
          searcher = this.payload;
        }

        if (this.routingAction != "feed") {
          console.log("SEARCH COMPONENT !!!222222");
          var that = this;
          this.storageService.searchContent({
            search: null
          }, function(content) {
            console.log("RREEEEEE");
            console.dir(content);
            that.showSearchResult({
              search: null
            }, content, "#main-dashboard");
          }, uid);
        } else {
          alert("USER FEED NOT IMPLEMENTED YET");
        }
      },
      getTagsBubbles: function(search, tags) {
        var result = '';
        for (var x in tags)
          result += '<li href="/?' + encodeURI('tags=' + tags[x] + '&search=' + (search.search ? search.search : '*')) +
          '">' + tags[x] + '</li>';
        return result;
      },
      getBranches: function(search, items) {
        var uitems = [];

        for (var x in items) {
          if (items[x].url.indexOf("https://github.com") == 0) {
            var rr = items[x].url.split("/");
            var branch = "github:" + rr[3] + "/" + rr[4];
            if (uitems.indexOf(branch) == -1)
              uitems.push(branch);
          } else if (items[x].url.indexOf("https://bitbucket.org") == 0) {
            var rr = items[x].url.split("/");
            var branch = "bitbucket:" + rr[3] + "/" + rr[4];
            if (uitems.indexOf(branch) == -1)
              uitems.push(branch);
          } else if (items[x].url.indexOf("https://cs.chromium.org") == 0) {
            var branch = "googlecode:cs.chromium.org";
            if (uitems.indexOf(branch) == -1)
              uitems.push(branch);
          }

        }

        //              <li><img src="img/googlecode.png"> <span>cs.chromium.org</span></li>
        //              <li><img src="img/github.png"> <span>philip.github.org</span></li>
        //              <li><img src="img/bitbucket.png"> <span>bitbucket.com/philip</span></li>

        var result = '';
        for (var x in uitems) {
          var branch = uitems[x].split(":");
          var icon = branch[0];
          result += '<li><img src="img/' + icon + '.png"> <span href="/?' +
            encodeURI('branches=' + branch[1] + '&search=' + (search.search ? search.search : '*')) +
            '">' + branch[1] + '</span></li>';
        }
        return result;
      },

      getDescription: function(description) {
        if (!description || description == "") {
          return '<img src="img/sad-face.png">\
                                        <div class="content">\
                                            <p>There is no description for this item!</p>\
                                            <p class="small">Please check again later, we will probably update it.</p>\
                                        </div>';
        }
        return '<p>' + description + '</p>';
      },
      showAvailableVersions: function(search, uid, versions) {
        var result = "";
        return result;

        for (var y in ["0", "1", "3"])
          result += '<a href="/?open=' + uid + '/' + y + '"><button type="button" class="btn btn-default btn-circle"><i class="glyphicon">' + y + '</i></button></a>';
        return result;
      },
      showSearchResult: function(searchString, searchData, pSel) {
        var pselector = pSel || "#main-content";
        $(pselector).empty();

        if (!searchData || Object.keys(searchData).length == 0) {
          $("<h1>THERE IS NOTHING TO RESULT OF YOUR SEARCH</h1>").prependTo(pselector);
          return;
        }
        for (var x in searchData) {
          var versions = searchData[x];
          var item = versions; //[versions.length - 1]; // it should be the latest version

          var description = searchData[x];
          var xxx = x.substr(1);
          var xuid = 0; //versions.length - 1;

          var panelTemplate2 = getTemplateGlobal("snippet", {
            snippet: {
              title: description.title,
              n_comments: description.items.length,
              n_watches: description.watches || 0,
              n_likes: description.stars || 0,
              labels: "", // getGlobalTemplates("snippet:labels", description.labels),
              username: item.user_name,
              uid: xxx,
              xuid: xuid,
              user_id: item.user_id,
              has_description: (description.description ? '' : 'no-'),
              description: this.getDescription(description.description),
              tags: this.getTagsBubbles(searchString, description.tags),
              branches: this.getBranches(searchString, description.items)
            }
          });

          $(panelTemplate2).prependTo(pselector);
        }


        $(".snippetor-play-snippet-new").click(function() {
          var uid = $(this).attr("uid");
          var xuid = parseInt($(this).attr("xuid"));

          var payload = searchData["-" + uid];

          if (!uid || xuid == undefined)
            return;

          payload.uid = uid; // save current unique ID

          payload.version = xuid;

          payload.isOpened = true;

          console.dir(payload);
          snippetorExtensionService.openSnippet(payload);
        });
      }
    };

    // component which is responsible for the list of snippets
    // showing and update.
    // @depends - depends on login and routing services
    // @required - uses firebase storage service and extension api service
    //
    var snippetDetailsComponent = {
      init: function(routingService, loginService, storageService, extensionService) {
        // cache the storage and extension services
        this.storageService = storageService;
        this.extensionService = extensionService;
        this.routingService = routingService;
        // subscribe on login change and routing change
        routingService.addObserver(this);
        loginService.addObserver(this);
        extensionService.addObserver(this);
      },
      storageService: null,
      routingAction: null,
      userId: undefined,
      //
      // Routing service callback method
      //
      onRoutingChanged: function(oldRouting, routingAction, payload) {
        this.routingAction = routingAction;
        this.payload = payload;

        console.log("PAYLOAD IS: ");
        console.dir(payload);
        this._updateComponent();
      },
      //
      // Authenticatoin service callback method
      //
      onAuthChanged: function(currentUser) {
        this.userId = currentUser ? currentUser.uid : null;
        this._updateComponent();
      },
      //
      // Load snippet data or update snippet
      //
      _updateComponent: function() {
        // There are only 3 routing actions supported
        if (this.routingAction != "edit-snippet" &&
          this.routingAction != "view-snippet" &&
          this.routingAction != "save-snippet")
          return;
        if (!this.extensionService.isInitialized() || this.userId == undefined)
          return;

        var that = this;
        //
        // Check if it is draft
        //
        if (this.routingAction == "save-snippet" && (!this.payload || !this.payload.uid)) {
          if (this.extensionService.isInitialized()) {
            var working_snippet = this.extensionService.getWorkingSnippet();
            if (working_snippet != undefined) {
              this.showContent(working_snippet, null, "#main-dashboard");
            } else {
              $("#main-dashboard").append("THERE IS NO SNIPPET DRAFT TO SAVE");
            }
          } else {
            console.log("waiting for extension initialization");
          }
        }
        //
        // Load content and edit it
        //
        else {
          var snippet = this.extensionService.getSnippetByUid(this.payload.uid);
          if (snippet) {
            that.showContent(snippet, null, "#main-dashboard");
            that.extensionService.subscribeSnippet(this.payload.uid, this);
          } else {
            this.storageService.loadContent(this.payload.uid, this.payload.version, function(data) {
              console.dir(data);
              if (data) data.uid = that.payload.uid;
              that.showContent(data, null, "#main-dashboard");
            });
          }
        }
      },
      //
      // Show the UI snippet list item (comment and information)
      //
      showContentItem: function(item, index, extApi) {

        var gh_prefix = "https://github.com/";
        var bb_prefix = "https://bitbucket.org/";
        var cs_prefix = "https://cs.chromium.org/";
        var uml_prefix = "https://umlsync-6e2da.firebaseapp.com/";
        var prefix = "";
        var img = "";

        if (item.url.indexOf(gh_prefix) == 0) {
          prefix = gh_prefix;
          img = "github";
        } else if (item.url.indexOf(cs_prefix) == 0) {
          prefix = cs_prefix;
          img = "google";
        } else if (item.url.indexOf(bb_prefix) == 0) {
          prefix = bb_prefix;
          img = "bitbucket";
        } else if (item.url.indexOf(uml_prefix) == 0) {
          prefix = uml_prefix;
          img = "puzzle-piece";
        }

        var url_path = item.url.substr(prefix.length);

        var panelTemplate = "";
        if (img != "google" && img != "puzzle-piece") {
          var user = url_path.substr(0, url_path.indexOf("/"));
          url_path = url_path.substr(url_path.indexOf("/") + 1);

          var repo = url_path.substr(0, url_path.indexOf("/"));
          url_path = url_path.substr(url_path.indexOf("/") + 1);

          panelTemplate = getTemplateGlobal("save-view-item", {
            item: {
              source: img,
              prefix: prefix,
              img: img,
              username: user,
              repo: repo,
              path: url_path,
              lineprefix: (img == "github" ? "#L" : "?fileviewer=file-view-default#-"),
              line: item.line,
              comment: item.comment,
              save_vis: (this.routingAction == "save-snippet" ? "block" : "none"),
              view_vis: (this.routingAction != "save-snippet" ? "block" : "none")
            }
          });
        } else if (img == "google") {
          panelTemplate = getTemplateGlobal("save-view-item-google", {
            item: {
              source: img,
              prefix: prefix,
              img: img,
              lineprefix: "?l=",
              line: item.line,
              path: url_path,
              comment: item.comment,
              save_vis: (this.routingAction == "save-snippet" ? "block" : "none"),
              view_vis: (this.routingAction != "save-snippet" ? "block" : "none")
            }
          });
        } // elese if bitbucket or github
        else {
          panelTemplate = getTemplateGlobal("save-view-item-uml", {
            item: {
              source: img,
              prefix: prefix,
              img: img,
              path: url_path,
              element: "Class,Package etc..",
              comment: item.comment,
              save_vis: (this.routingAction == "save-snippet" ? "block" : "none"),
              view_vis: (this.routingAction != "save-snippet" ? "block" : "none")
            }
          });
        }
        //

        var item = $(panelTemplate).addClass("snippet-item");
        if (index <0 ) {
          item.appendTo("#snipettor-save-form");
        }
        else {
          var l = $('div.snippet-item:eq('+ (index -1) +')');
          l.after(item);
        }

        //
        //  Snippet comment handlers
        //  remove and edit broadcast and synchronization
        //
        item.find(".close-snippet-item-icon").click(function() {
          var parent = $(this).parent().parent().parent().parent();
          var idx = $(".panel-default").index(parent);

          extApi.updateSnippetItem("delete", {
            index: idx
          });
          parent.remove();
        });
        // edit the text of comment
        item.find(".fa-edit").click(function() {
          var parent = $(this).parent().parent();
          var elemIndex = $(".panel-default").index(parent.parent());

          if (parent.find("textarea").length > 0) {
            parent.find("textarea").trigger("blur");
            return;
          }

          var text = parent.find(".snippet-description").html();
          parent.find(".snippet-description").hide();
          parent.append("<textarea style='width:100%;'>" + text + "</textarea>");
          parent.find("textarea").blur(function() {
            var xxx = parent.find("textarea").val();
            parent.find("textarea").remove();
            if (xxx != text) {
              parent.find(".snippet-description").text(xxx);
              extApi.updateSnippetItem("update", {
                idx: elemIndex,
                item: {
                  comment: xxx
                }
              });
            }
            parent.find(".snippet-description").show();
          });
        });

        // Toggle tooltips showing
        $('[data-toggle="tooltip"]').tooltip();

      },
      addSaveForm: function(payload, idx, pselector) {
        // remove the previous form and create a new one
        $("#snipettor-save-form").remove();
        // INITIALIZE TEMPLATE
        var saveTemplate = getTemplateGlobal("save-view", {
          snippet: {
            uid: (payload.uid || ''),
            title: payload.title,
            tags: (payload.tags ? payload.tags.join(",") : ""),
            desc: (payload.description || ""),
            editable: (this.routingAction == "view-snippet" ? "not-editable" : ""),
            disabled: (this.routingAction == "view-snippet" ? "disabled" : "")
          }
        });
        // Add template to DOM
        $(saveTemplate).appendTo(pselector);
        // HANDLE FOCUS
        if (this.routingAction == "save-snippet")
          $("#snippetor-save-title")
          .focus()
          .val($("#snippetor-save-title").val());
        // Input tags
        $("#snippetor-save-tags").tagsinput({});

        // configure and initialize buttons
        this._configureButtonsVisiblity(payload);
        this._requestLikeAndWatchDetails(payload);
        this._addButtonsActions(payload);
      },
      _requestLikeAndWatchDetails: function(payload) {
        // there is no like and watch buttons for save mode
        if (this.routingAction != "view-snippet")
          return;
        //
        // hide like and watch options if user
        // not authorized
        //
        if (!this.userId) {
          $("[name='like']").hide();
          $("[name='watch']").hide();
          return;
        }

        this.storageService.requestLikeAndWatch(this.userId + payload.uid,
          function(data) {
            if (data) {
              $("[name='like']").attr("status", data.like);
              $("[name='watch']").attr("status", data.watch);
            } else {
              // first time user opened current snippet
              // or never liked or watched it
              $("[name='like']").attr("status", false);
              $("[name='watch']").attr("status", false);
            }
          });
        //
        // HAndle like and watch
        var that = this;

        function handleLW(e) {
          var like = $("[name='like']").attr("status") == "true",
            watch = $("[name='watch']").attr("status") == "true";
          // toggle current like/watch status
          if ($(this).attr("name") == "like") {
            like = !like;
            $("[name='like']").attr("status", like);
          } else {
            watch = !watch;
            $("[name='watch']").attr("status", watch);
          }
          that.storageService.setLikeAndWatch(that.userId + payload.uid, {
            like: like,
            watch: watch
          });
        };
        //
        // common handler for like and watch
        $("[name='like']").click(handleLW);
        $("[name='watch']").click(handleLW);
      },
      _configureButtonsVisiblity: function(payload) {
        // Configure the buttons visibility
        if (payload.uid && this.routingAction == "view-snippet") {
          // nothing change therefore nothing to cancel
          // or delete
          $("[name='delete']").hide();
          $("[name='cancel']").hide();
          // it should be possible to fork current snippet
          $("[name='fork']").show();
          if (payload.isModified) {
            $("[name='revert']").show();
          } else {
            $("[name='edit']").show();
          }

          if (payload.isOpend) {
            if (payload.isModified || payload.isEditMode) {
              // Switch to the editable mode
              // Make input editable and list of comments sortable
            }
          } else {
            if (payload.isModified)
              alert("SOMETHING GO WRONG: NOT OPENED CONTENT COULD NOT BE MODIFIED.");
          }
        } else if (this.routingAction == "save-snippet") {
          // There is no support of isModified state for a draft snippet
          $("[name='save']").show();
          // Cancel cahnge or Delete draft
          if ((this.payload && this.payload.uid) || payload.uid) {
            $("[name='delete']").hide();
          } else {
            $("[name='cancel']").hide();
          }
          $("[name='close']").hide();
          $("[name='watch']").hide();
          $("[name='like']").hide();
        }
      },
      _addButtonsActions: function(payload) {
        var that = this;
        //
        // Open snippet via extension remote API
        //

        $("[name='play']").click(function() {
          payload.isOpened = true;
          that.extensionService.openSnippet(payload, 0);
        });
        //
        // switch snippet to the edit mode
        //
        $("[name='edit'").click(function() {
          that.routingService.changeUrl("/?save=" + payload.uid, true);
        });
        //
        // Save content to the firebase storage
        //
        function _forkOrSaveHAndler(e) {
          e.preventDefault();
          e.stopPropagation();
          var action = $(this).attr("name");

          if (action == "save" || action == "fork") {
            // Update title tags and description
            payload.title = $("#snippetor-save-title").val();
            payload.tags = $("#snippetor-save-tags").val();
            payload.tags = payload.tags ? payload.tags.split(",") : [];
            payload.description = $("#snippetor-save-description").val();

            // make dedicated list of branches
            payload.branches = that._updateListOfBranches(payload);

            var uid = $(this).attr("uid") || payload.uid;
            //var that = this;
            if (!uid || uid == "" || action == "fork") {
              // reset values for a fork
              payload.uid = undefined;
              payload.version = undefined;
              // reset is modified before save
              payload.isModified = undefined;
              // SAVE CONTENT
              that.storageService.saveContent(payload, function(path) {
                var uniquePath = path;
                uniquePath = path.toString().split("/")[2];
                uniquePath = uniquePath.substr(1);

                // handle snippet save
                that.extensionService.onSavedSnippet({
                  uid: uniquePath
                });

                setTimeout(function() {
                  window.location.href = "/?save=" + uniquePath;
                }, 100);
              });
            } else {
              that.storageService.updateContent(uid, payload, function(path) {
                var uniquePath = path.uid;
                uniquePath = path.toString().split("/")[2];
                uniquePath = uniquePath.substr(1);

                // handle snippet saved
                that.extensionService.onSavedSnippet({
                  uid: uniquePath,
                  version: path.version
                });

                setTimeout(function() {
                  window.location.href = "/?open=" + uniquePath + "/" + path.version + "/";
                }, 100);
              }); // update content API
            }
          }
          return false;
        }; // on sumbit method
        $("[name='save']").click(_forkOrSaveHAndler);
        $("[name='fork']").click(_forkOrSaveHAndler);
        //
        // cancel current changes
        //
        $("[name='cancel'").click(function() {
          if (that.routingAction == "save-snippet") {
            that.extensionService.onSavedSnippet({
              payload: {
                uid: payload.uid
              }
            });
            setTimeout(function() {
              window.location.href = "/?open=" + payload.uid;
            }, 100);
          }
        });
        //
        // close current snippet
        //
        $("[name='close']").click(function() {
          //
          // If snippet was opened with extension
          // then we should notify extension about
          // snippet is closing
          that.extensionService.onSavedSnippet({
            payload: {
              uid: payload.uid
            }
          });

          // close snippet if it was opened
          if (that.routingAction == "view-snippet") {
            setTimeout(function() {
              window.location.href = "/";
            }, 100);
          }
        });
        //
        // delete current draft
        //
        $("[name='delete'").click(function() {
          if (that.routingAction == "save-snippet") {
            that.extensionService.onSavedSnippet(payload);
            setTimeout(function() {
              window.location.href = "/";
            }, 100);
          }
        });

      },
      //
      // Update list of branches
      // Note: work-around method to provide the list of branches
      //       on snippet preview in the list search
      //
      _updateListOfBranches: function(payload) {
        var branches = [];
        for (var x in payload.items) {
          var item = payload.items[x];
          if (item.url.indexOf("https://github.com") >= 0) {
            var z = item.url.split("/");
            z = z[3] + "/" + z[4];
            // add unique branch name
            if (!(z in branches))
              branches.push(z);
          }
        }
        return branches;
      },
      //
      //  Show content of the snippet
      //
      showContent: function(payload, idx, pselector) {
        $(pselector).empty();
        //
        // configure edit/view form based on the user
        // capabilities
        this.addSaveForm(payload, idx, pselector);
        //
        // list all snippets comment
        for (var r = 0; r < payload.items.length; ++r) {
          this.showContentItem(payload.items[r], -1, this.extensionService);
        } // for
      }, // show Content method
      //
      // Snippet extension observer
      //
      initCallback: function(response) {
        this._updateComponent();
      },
      onSaveSnippet: function(payload) {
        // Closed current snippet
        if (payload.working == this.extensionService.working_snippet) {
          window.location.href = "/";
        }
      },
      // we can get item callback
      // for the current snippet only
      onAddItem: function(payload) {
        this.showContentItem(payload.item, payload.index, this.extensionService);
      },
      onRemoveItem: function(payload) {
        $('li.snippet-item:eq('+ payload.index +')').remove();
      },
      onMoveItem: function(payload) {
        var item = $('li.snippet-item:eq('+ payload.oldIndex +')');
        $('li.snippet-item:eq('+ payload.newIndex +')').after(item);
      },
      onUpdateItem: function(payload) {
        // Update text area for the corresponding item
        $('li.snippet-item:eq('+ payload.index +')')
        .find("textarea")
        .val(payload.item.comment);
      },
      handleWorkingSnippet: function(id, force) {
        if (this.snippets.length > id) {
          this.working = id;
          if (this.routingAction == "save-snippet")
            this.showContent(this.snippets[id], id, "#main-dashboard");
          else if (force) {
            window.location.href = "/?save=DRAFT";
          }
        }
      },
      onSaveCurrentSnippet: function() {
        window.location.href = "/";
      },
      doSwapItems: function(action) {
        if (action.oldIndex == action.newIndex)
          return;

        var lis = $('div.panel-default');
        console.dir(action);
        console.dir(lis);
        var ttt = lis.eq(action.oldIndex);
        var new_ttt = lis.eq(action.newIndex);
        console.dir(ttt);
        if (action.newIndex < action.oldIndex) {
          new_ttt.before(ttt);
        } else {
          new_ttt.after(ttt);
        }
      }
    };

    //
    // Right site user details view
    //
    var userDetailsComponent = {
      init: function(loginService, storageService, routingService) {
        this.storageService = storageService;
        loginService.addObserver(this);
        routingService.addObserver(this);
      },
      authInitialized: false,
      onAuthChanged: function(newUser) {
        this.authInitialized = true;
        this.currentUser = newUser;
        this._updateComponent();

      },
      onRoutingChanged: function(oldR, newR, payload) {
        this.routingAction = newR;
        this.routingPayload = payload;
        this._updateComponent();
      },
      _updateComponent: function() {
        var that = this;
        if (this.routingAction == "dashboard" && this.routingPayload && this.routingPayload.uid) {
          //
          // Request user information from the firebase storage
          //
          this.storageService.getUserInfo(this.routingPayload.uid, function(newUser) {
            that.showUserDetails(newUser);
          });
        } else if (this.routingAction && this.authInitialized && this.currentUser) {
          this.storageService.getUserInfo(this.currentUser.uid, function(newUser) {
            that.showUserDetails(newUser);
          });
        }
      },
      shown: false,
      showUserDetails: function(user) {
        if (this.shown || !user) return;
        this.shown = true;
        var template = getTemplateGlobal("user-profile-details", {
          profile: {
            username: user.name,
            avatar: user.photo,
            followers: user.followers,
            following: user.following
          }
        });
        console.log("MMMMMMMMMMMMMMMMMMMMMMMMMMMMM");
        console.dir(user);

        $(template).prependTo("#snippetor-sidebar-profile");
      }
    };

    var container = null;
    $(document).ready(function() {
      //
      // Authentication part
      //
      singInMenuComponent.init(firebase, storageApi);
      tabsController.init(storageApi, routingServiceApi);
      userDetailsComponent.init(storageApi, storageApi, routingServiceApi);
      workingSnippetsComponent.init(snippetorExtensionService);
      // initialize components
      searchListComponent.init(routingServiceApi, storageApi, storageApi, snippetorExtensionService);
      snippetDetailsComponent.init(routingServiceApi, storageApi, storageApi, snippetorExtensionService);


      // right side menu of the user
      // userDetailsComponent.init(routingServiceApi, storageApi, storageApi);

      // active snippets dropdown menu
      // activeSnippetsComponent.init(extensionService);


      //
      // Connect to the firebase storage
      //
      storageApi.init();

      // initialize routing information
      routingServiceApi.init(decodeURI(window.location.href));

      //
      // Update snippet navigation tool-bar
      //
      uiHandler = {
        updateSearchForm: function(query) {
          $("[name='search']").val(query.search || "");
          $("[name='branches']").val(query.branches || "");
          $("[name='tags']").val(query.tags || "");
        }
      };

      snippetorExtensionService.init();
    }); // document ready
  </script>

</body>

</html>
